{% load pipeline %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Academic reserve</title>
    {% javascript 'vue' %}
    {% javascript 'lodash' %}
    {% stylesheet 'foundation' %}
</head>
<body>

{% verbatim %}
<nav>
<div class="top-bar">
  <div class="top-bar-left">
    <ul class="dropdown menu" data-dropdown-menu>
      <li class="menu-text">Академический резерв</li>
      <li><a href="/">Участники программы</a></li>
        <li><a href="/reports">Отчёты</a></li>
      <li><a href="/admin/">Администрирование</a></li>
    </ul>
  </div>
  <div class="top-bar-right">
    <ul class="menu">
    </ul>
  </div>
</div>
</nav>
<div class="app">
<div id="app"></div>
</div>
<style>
    .app{
        margin: 2% 0 0 5%;
    }
    .status-header, .reports-header{
        margin-left: -3%;
    }

    td.callout
    {
        border: 0px;
    }

</style>
    <script>

        const Reserve = {
            name: 'Reserve_table',
            data: () => ({
              reserve: []
            }),
            computed:
                {
                      groupedReserve(){
                    return _.mapValues(_.groupBy(this.reserve, 'status'),
                        status_group =>
                            _.mapValues(_.groupBy(status_group, 'category'),
                                c_group => ({
                                    participations: c_group[0].participations,
                                    reservists: c_group
                                })
                            ));
                },
                },
                        mounted: function() {
                            this.$http.get('api/reserve/').then(function (resp) {
                                    this.reserve = resp.data;
                                },
                                function (resp) {
                                    console.log(resp);
                                });
                        },
            template: `<div>
                <div v-for="(categories,status) in groupedReserve">
        <h4 class="status-header">Статус участия: {{ status }}</h4>
        <div v-for="(table, category) in categories">
            <h5>{{ category }}</h5>
            <table>
                <thead>
                <th style="width:300px;">Сотрудник</th>
                <th style="width:200px;">Должность</th>
                <th style="width:100px;">Возраст</th>
                <th style="width:120px;">Стаж</th>
                <th style="width:100px;">Учёная степень</th>
                <th v-for="pstage in table.participations">
                 <!--   <a :href="pstage.stage.admin_url">{{ pstage.stage.name }}</a><br/> -->
                </th>
                </thead>
                <tr is="reservist-row" v-for="r in table.reservists" :res="r" :key="r.url"></tr>
            </table>
        </div>
    </div>
    </div>
            `,
                        components:
                {
                    'reservist-row': {
                props: ['res'],
                template: `<tr>
                       <td><a :href="res.admin_url">{{ res.name }}</a><br/>
                        <a :href="res.personal_page" class="fi-web"></a>
                        <a :href="mailto(res.email)" class="fi-at-sign"></a></td>
                    <td class="callout" v-bind:class="{warning: res.warnings.department}">
                    <span style="font-style:italic;">{{ res.position }}</span><br/>
                    {{ res.department }}</td>
                        <td class="callout" v-bind:class="{alert: res.warnings.age}">{{ res.age }}</td>
                    <td class="callout" v-bind:class="{alert: res.warnings.hse}">{{ res.experience }}</td>
                    <td class="callout" v-bind:class="{alert: res.warnings.phd}">{{ res.phd }}</td>
                    <td style="width:200px;" class="callout" v-bind:class="{warning: stagewarning(pstage)}" v-for="pstage in datesort(res.participations)">
                        <a :href="pstage.stage.admin_url">{{ pstage.stage.name }}</a>
                        <div class="fi-calendar"> {{ pstage.stage.deadline }}
                            <a :href="reminder(res, pstage.stage)" class="fi-mail" onclick="return confirm('Send mail')"></a>
                        </div>
                        <select v-model="pstage.step_selected">
                            <option v-for="step in pstage.stage.steps" :value="step.id">{{ step.name }}</option>
                        </select>
                    </td></tr>`,
                methods: {
                    mailto(email){
                        return 'mailto:' + email;
                    },
                    datesort(part){
                        return _.sortBy(part, "stage.deadline");
                    },
                    stagewarning(pstage)
                    {
                        return pstage.stage.warning && (pstage.step_selected == _.first(pstage.stage.steps).id);
                    },
                    reminder(res, stage)
                    {
                        return "reminders/reservist/" + res.id + "/stage/" + stage.id;
                    }
                },
                watch: {
                    'res.participations':{
                        handler: function () {
                            this.$http.patch(this.res.url, {
                                'participations': this.res.participations
                            })
                        },
                    deep: true
                    },
                }
            }
                }
        }

        const Reports = {
            name: 'Reports',
            data: () => ({
                report_stages: []
            }),
                        mounted: function() {

                this.$http.get('/api/reports/').then(function (resp) {
                    this.report_stages = resp.data;
                },
                    function(resp) {
                    console.log(resp);
                });

            },
            computed: {
                              reports(){
                    return _.mapValues(this.report_stages,
                        report_stage => (
                            _.mapValues(report_stage.templates,
                            template => ({
                                    name : template.name,
                                   stagename: report_stage.stagename,
                                   url: report_stage.url + "/template/" + template.id
                                }
                            ))
                        )
                    );
                }
            },
            template: `
                <div>
<h4 class="reports-header">Отчёты</h4>
    <ul v-for="report_stage in reports">
        <li v-for="report in report_stage">
            <a :href="report.url" class="fi-page-export-doc"> {{ report.stagename }} [{{ report.name }}]</a>
        </li>
    </ul>
</div>
            `
        }

        const routes =
            {
                '/' : Reserve,
                '/reports/': Reports,
            }

        var vm = new Vue({
            el: '#app',
            data: {
                currentRoute: window.location.pathname,
            },
            computed: {
                  ViewComponent () {
                     return routes[this.currentRoute] || NotFound
                    },
            },
            render (h) { return h(this.ViewComponent) },
        });

        window.addEventListener('popstate', () => {
  vm.currentRoute = window.location.pathname
});
    </script>
</body>
</html>
{% endverbatim %}